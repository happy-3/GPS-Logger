# Flight Assist 機能追加計画

## 概要
現在の GPS Logger プロジェクトを基盤として、要件定義書で示された新機能を実装するための方針と試験方法を整理する。

本計画では主に以下の項目を検討する：

1. データ取得機能の拡張
2. 計算ロジックの追加
3. UI の改修とハプティックフィードバック
4. ロギング・エクスポート機能の拡張
5. 試験計画

## 1. データ取得機能
### 1.1 GPS 位置取得 (ACQ‑GPS)
- `CLLocationManager` の `desiredAccuracy` を `kCLLocationAccuracyBestForNavigation` とする。
- iOS 18 以降ではデュアル周波数 (L1 + L5) を自動利用するため、追加設定は不要。
- 位置更新周期は既存コードの `logInterval` を流用し、少なくとも 1 Hz を確保する。

### 1.2 CAS/Hₚ 入力 (ACQ‑MAN)
- UI に手動入力フィールドを追加し、CAS は 10 kt 単位、高度は 1000 ft 単位で入力させる。
- GPS 高度と地上気温を使用して気圧高度を推定する処理を `AltitudeFusionManager` とは別に実装する。
- 将来的な BLE 圧力センサ統合を考慮し、入力ソースを抽象化するプロトコル `PressureAltitudeSource` を定義する。

### 1.3 ロギング拡張 (ACQ‑LOG)
- 既存の CSV 出力に以下の新規列を追加する：
  - 推定 OAT
  - 計算した理論 CAS′
  - 計算した理論 Hₚ′
  - ΔCAS, ΔHₚ
- `FlightLog` 構造体へ対応するプロパティを追加し、`FlightLogManager` で保存する。

## 2. 計算ロジック
### 2.1 ISA 大気モデル (CALC‑ATM)
- `ISAAtmosphere` クラスを新規作成し、トループ式と成層圏式を 0〜50 kft でサポートする。
- 温度は lapse rate 0.0065 K/m を適用し、高度 11 000 m 以降は指数式とする。

### 2.2 三脚法による TAS/風算出 (CALC‑TAS)
- `TASTriangularSolver` クラスを実装する。3 レグの速度・方位データを 10 s 分受け取り、最小二乗法で TAS と風速を求める。
- 回転中のデータは無視できるよう、`Start`/`Turn`/`Stop` イベント時刻で区切りログを取得する。

### 2.3 OAT 算出 (CALC‑OAT)
- TAS とマッハ数から OAT を求める式 `OAT = (TAS/M)^2 /(γR) - 273.15` を実装する。
- γ=1.4、R=287 とし、単位変換を考慮するユーティリティ関数を追加する。

### 2.4 ΔCAS/ΔHₚ 計算 (CALC‑ERR)
- 求めた OAT を用いて同一 TAS となる CAS′、Hₚ′ を `ISAAtmosphere` から逆算し、計器値との差分を算出する。
- 計算結果はリアルタイム表示と CSV ログに利用する。

## 3. UI とハプティック
### 3.1 メイン表示
- `ContentView` を拡張し、TAS、CAS、Hₚ、ΔCAS を大きなフォントで常時表示するエリアを追加。
- レグ管理ボタン `Start` `Turn` `Stop` を配置し、押下時に `LocationManager` へイベントを通知する。

### 3.2 ハプティックパターン
- `HapticFeedbackManager` (仮称) を作成し、Core Haptics を用いて要件表のパターンを発生させる。
- 逸脱警報は計算モジュールからトリガーし、繰り返し回数や強度を調整できるよう設定値として保持する。

## 4. ロギング・共有
- フライト終了時にセッションフォルダ内へ CSV と SVG グラフを自動生成し、`UIActivityViewController` で共有する。
- ΔCAS vs CAS のグラフ描画には `CoreGraphics` を使用し、SVG 形式で出力するユーティリティを実装する。

## 5. 試験計画
### 5.1 ユニットテスト
- 新規計算クラス (ISAAtmosphere, TASTriangularSolver 等) について、誤差 ±0.05 % 以内となるよう既知値との比較テストを `XCTest` ベースで作成する。
- 例：標準大気表の値と一致するか、三脚法の計算結果が期待値と一致するかを検証。

### 5.2 シミュレータテスト
- Xcode シミュレータ上で UI の動作確認を行い、ハプティックがシミュレータで再生されるか確認する。
- TestFlight を利用した実機テストで、GPS データ取得とログ保存を検証する。

### 5.3 フィールドテスト
- 要件に示された高度・速度点 (5 kft, 10 kft, 30 kft, 50 kft、CAS 100–400 kt) で実際に飛行し、ΔCAS 曲線を取得する。
- 取得データをもとに計算モジュールの精度を評価し、必要に応じてパラメータを調整する。

以上を実施することで、要件定義書に沿った Flight Test Assist App への発展が可能となる。
